<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Word Puzzle - ä¿®å¤ç‰ˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #FFF3E0;
    --primary-color: #7B61FF;
    --primary-dark: #5E4AD3;
    --text-brown: #333333;
    
    /* åŸºç¡€å°ºå¯¸ä¿æŒåŸç‰ˆï¼Œä¸å†åœ¨iPadä¸Šå¼ºåˆ¶åŠ å¤§ä¸»é¡µå…ƒç´  */
    --item-height: 52px;
    --item-min-width: 110px;
    --item-radius: 16px;
    --current-theme: #7B61FF; 
}

/* --- iPad ä¸“å±é€‚é…ï¼ˆä»…é’ˆå¯¹ã€æ¸¸æˆå†…ã€‘çš„æ“ä½œåŒºåŸŸä¼˜åŒ–ï¼Œä¸æ”¹ä¸»é¡µï¼‰ --- */
@media (min-width: 768px) {
    /* ä»…å¾®è°ƒæ¸¸æˆå†…çš„å¡ç‰‡ï¼Œæ–¹ä¾¿æ‰‹æŒ‡è§¦æ‘¸ */
    :root {
        --item-height: 64px;      
        --item-min-width: 130px;
        --item-radius: 18px;
    }

    /* é™åˆ¶æ¸¸æˆç›˜æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢åœ¨ iPad Pro ä¸Šå¤ªå®½éš¾æ“ä½œ */
    .game-board { 
        width: 85% !important; 
        max-width: 850px !important; 
    }
    
    /* å¢åŠ è¯åº“é«˜åº¦ï¼Œæ–¹ä¾¿å±•ç¤ºæ›´å¤šå•è¯ */
    .word-bank { 
        height: 180px !important; 
    }
    
    /* ä¿®å¤ï¼šä¸»é¡µå­—ä½“å’Œå¸ƒå±€å®Œå…¨ä¸æ ¹æ®å±å¹•å˜å¤§è€Œæ”¹å˜ï¼Œä¿æŒåŸæ · */
    .app-title { font-size: 3.2rem !important; }
}

body {
    font-family: 'Varela Round', 'YouYuan', 'å¹¼åœ†', 'Microsoft YaHei', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    min-height: 100vh;
    overflow-x: hidden;
    user-select: none;
    -webkit-user-select: none; /* iOS Safari */
    color: var(--text-brown);
    -webkit-tap-highlight-color: transparent;
}

.hidden { display: none !important; }
.fade-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

@keyframes popIn {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

/* --- ä¸»é¡µæ ·å¼ (ä¿æŒåŸç‰ˆç´§å‡‘è®¾è®¡) --- */
#home-view {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 20px 40px 20px; 
}

.header-section {
    text-align: center;
    margin-bottom: 30px; 
    margin-top: 20px;
    position: relative;
    animation: float 4s ease-in-out infinite;
}

.app-title {
    font-family: 'Fredoka One', cursive;
    font-size: 3.2rem;
    color: var(--primary-color);
    margin-bottom: 16px;
    font-weight: 900;
    letter-spacing: 2px;
}

.total-star-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #FFF;
    padding: 0 28px;
    height: 48px;
    border-radius: 50px;
    box-shadow: 0 6px 0 #FFE0B2, 0 10px 10px rgba(0,0,0,0.1);
    gap: 12px;
    border: 3px solid #FFCC80;
}

.total-star-icon { width: 34px; height: 34px; fill: #FFD700; overflow: visible; display: block; }
.total-star-count { font-size: 1.8rem; font-weight: 900; color: #F57F17; position: relative; top: 2px; }

.level-grid {
    display: grid;
    /* ä¿æŒå“åº”å¼ Gridï¼Œä¸å¼ºåˆ¶æ”¹å˜åˆ—å®½ */
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    padding-bottom: 40px;
}

.level-card {
    background: white;
    border-radius: 28px;
    cursor: pointer;
    box-shadow: 0 8px 0 #E0E0E0, 0 12px 20px rgba(0,0,0,0.1);
    transition: transform 0.1s;
    border: 3px solid #FFF;
    overflow: hidden;
    display: flex; flex-direction: column;
}
.level-card:active { transform: scale(0.98); }

.card-header-bg {
    background-color: var(--level-bg-alpha);
    padding: 20px 24px 12px 24px;
    border-bottom: 2px dashed rgba(0,0,0,0.05);
}

.card-header-row { display: flex; justify-content: space-between; align-items: center; }
.card-title { font-size: 1.6rem; font-weight: 900; color: var(--text-brown); margin: 0; }
.card-tag {
    font-size: 0.9rem; padding: 6px 14px; border-radius: 20px; font-weight: 600;
    background-color: #FFF; color: var(--level-color);
}
.card-body { padding: 15px 24px 20px 24px; display: flex; flex-direction: column; gap: 15px; }
.preview-words {
    font-size: 1rem; color: #90A4AE; font-weight: 600;
    background: #F5F7F8; padding: 8px 12px; border-radius: 12px;
}
.card-footer { display: flex; justify-content: space-between; align-items: center; }
.card-stars { display: flex; gap: 5px; }
.rounded-star { width: 28px; height: 28px; fill: #ECEFF1; overflow: visible; }
.rounded-star.earned { fill: #FFD700; filter: drop-shadow(0 2px 0 #F9A825); }
.play-icon {
    width: 36px; height: 36px; background: var(--level-color);
    border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; 
}

/* --- æ¸¸æˆç•Œé¢ --- */
#game-view {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background-color: var(--bg-color);
    z-index: 100;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 0; overflow: hidden;
}

.game-header {
    width: 90%; max-width: 950px; flex-shrink: 0;
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
}

.btn-3d {
    border: none; outline: none; cursor: pointer;
    font-family: inherit; font-weight: 800;
    transition: all 0.1s; position: relative; user-select: none;
    background: #FFF; padding: 10px 24px; border-radius: 50px;
    box-shadow: 0 5px 0 #CFD8DC, 0 10px 10px rgba(0,0,0,0.1);
}
.btn-3d:active { transform: translateY(4px) !important; box-shadow: 0 0 0 transparent !important; }

.back-btn {
    color: #555; font-size: 1.1rem;
    display: flex; align-items: center; gap: 8px; border: 2px solid #ECEFF1;
}

.current-level-title {
    font-size: 2.2rem; font-weight: 900; 
    color: var(--text-brown) !important;
    text-shadow: 2px 2px 0 #FFF;
}

.game-board {
    position: relative; background: #FFF; padding: 20px;
    border-radius: 36px;
    box-shadow: 0 15px 0 rgba(0,0,0,0.05), 0 30px 50px rgba(0,0,0,0.1);
    width: 90%; max-width: 950px; 
    /* ç§»é™¤ max-heightï¼Œé˜²æ­¢é«˜åº¦ä¸å¤Ÿå¯¼è‡´å›¾ç‰‡å‹ç¼© */
    display: flex; flex-direction: column; align-items: center;
    border: 6px solid #FFCC80;
}

/* --- æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢å›¾ç‰‡é”™ä½ --- */
.scene-wrapper {
    position: relative; 
    width: 100%; 
    /* å¼ºåˆ¶é”å®š 16:9 æ¯”ä¾‹ï¼Œè¿™æ˜¯é˜²æ­¢åæ ‡é”™ä½çš„å…³é”® */
    aspect-ratio: 16 / 9;
    /* ç§»é™¤ max-heightï¼Œè®©å®ƒè‡ªç„¶æ ¹æ®å®½åº¦ç¼©æ”¾ */
    border-radius: 24px; overflow: hidden;
    background: #F4F8FB; 
    box-shadow: inset 0 0 20px rgba(0,0,0,0.05); 
    margin-bottom: 20px;
    border: 3px solid #ECEFF1;
}

.scene-image { 
    width: 100%; 
    height: 100%; 
    /* å¼ºåˆ¶å¡«æ»¡å®¹å™¨ï¼Œä¸ç•™ç™½è¾¹ï¼Œç¡®ä¿åæ ‡ç»å¯¹å‡†ç¡® */
    object-fit: fill; 
    display: block; 
}

.hint-btn {
    background: #FFF; border: 3px solid #FFCDD2;
    color: #E57373; font-size: 1rem;
    box-shadow: 0 4px 0 #FFCDD2; 
    display: flex; align-items: center; gap: 6px;
}

/* ç›®æ ‡æ¡† */
.drop-target {
    position: absolute; transform: translate(-50%, -50%);
    min-width: var(--item-min-width); height: var(--item-height);
    background: rgba(255, 255, 255, 0.2); /* ç¨å¾®å¢åŠ é€æ˜åº¦ä»¥ä¾¿è°ƒè¯• */
    border: 2px dashed rgba(255,255,255,0.9);
    border-radius: var(--item-radius);
    display: flex; justify-content: center; align-items: center;
    transition: all 0.2s; z-index: 10; box-sizing: border-box;
}
.drop-target::after {
    content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
    width: 8px; height: 8px; background: #FFF; border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-top: 8px;
    border: 2px solid var(--current-theme);
}
.drop-target.hovered {
    background: rgba(255, 255, 255, 0.6);
    transform: translate(-50%, -50%) scale(1.1);
    border-color: #FFF;
    box-shadow: 0 0 25px rgba(255,255,255,0.8);
}
.drop-target.filled { border: none !important; background: transparent !important; }
.drop-target.filled::after { display: none; }

/* è¯åº“ä¸å¡ç‰‡ */
.word-bank {
    display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;
    padding: 10px; width: 100%; height: 160px; 
    align-content: flex-start; overflow-y: auto;
    -webkit-overflow-scrolling: touch; 
}

.word-card {
    background: white;
    min-width: var(--item-min-width); height: var(--item-height);
    padding: 0 20px; box-sizing: border-box;
    border-radius: var(--item-radius);
    display: flex; justify-content: center; align-items: center;
    font-weight: 700; font-size: 1.2rem; color: #546E7A;
    border: 2px solid #ECEFF1;
    border-bottom-width: 4px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: transform 0.1s;
    cursor: grab; position: relative;
    user-select: none;
    touch-action: none; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
    z-index: 50;
}

.word-card::before {
    content: ''; display: inline-block; width: 10px; height: 10px;
    border-radius: 50%; background-color: var(--current-theme);
    margin-right: 8px;
}

/* æ‹–æ‹½æ—¶çš„æ ·å¼ */
.word-card.dragging {
    position: fixed; 
    opacity: 0.9;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    transform: scale(1.1) !important;
    pointer-events: none; 
    z-index: 9999;
}

.word-card.placed {
    cursor: default; width: 100%; height: 100%;
    background: var(--current-theme);
    color: white; border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    animation: jellyBounce 0.5s;
    border-radius: var(--item-radius);
    font-size: 1.4rem;
}
.word-card.placed::before { display: none; }

@keyframes jellyBounce { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
@keyframes pulseTarget { 50% { transform: translate(-50%, -50%) scale(1.2); border-color: #FF5252; } }
@keyframes pulseCard { 50% { transform: scale(1.1); background-color: #FFEBEE; } }
@keyframes wrongShake { 0%, 100% { transform: translate(-50%, -50%); } 20%, 60% { transform: translate(-55%, -50%); } 40%, 80% { transform: translate(-45%, -50%); } }

.drop-target.hint-target { animation: pulseTarget 1s infinite; background: rgba(255, 255, 255, 0.5) !important; }
.word-card.hint-target { animation: pulseCard 1s infinite; }
.wrong-shake { animation: wrongShake 0.4s; border-color: #FF5252 !important; }

/* Modal æ ·å¼ */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
    display: none; justify-content: center; align-items: center; z-index: 10000;
}
.modal-card {
    background: #FFF; padding: 40px; border-radius: 40px; text-align: center;
    max-width: 420px; width: 90%;
    box-shadow: 0 20px 0 rgba(0,0,0,0.1);
    animation: popIn 0.5s;
    position: relative;
    display: flex; flex-direction: column;
}
.modal-card::before {
    content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 600px; height: 600px; background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
    z-index: -1; pointer-events: none;
}
.star-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
.star-box { width: 80px; height: 80px; opacity: 1; transform: scale(1); transition: all 0.3s; }
.star-svg { width: 100%; height: 100%; fill: #ECEFF1; overflow: visible; }
.star-box.active .star-svg { fill: #FFD700; filter: drop-shadow(0 4px 0 #F57F17); }
.star-box.active { animation: popIn 0.5s; }
.modal-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.btn-primary { background: var(--primary-color); color: white; border: none; }
.btn-secondary { background: #CFD8DC; color: #546E7A; }
.level-word-list { background: #F4F8FB; border-radius: 20px; padding: 15px 20px; margin: 10px 0 15px 0; max-height: 180px; overflow-y: auto; text-align: left; }
.word-list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #DEE4E7; font-size: 1.05rem; }
.word-en { font-weight: 800; color: var(--primary-color); }
.word-cn { font-weight: 500; color: #78909C; }

</style>
</head>
<body>

<div id="home-view" class="fade-in">
    <div class="header-section">
        <div class="app-title">Word Puzzle</div>
        <div class="total-star-badge">
            <svg class="total-star-icon" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z" /><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg>
            <span id="total-stars-count" class="total-star-count">0</span>
        </div>
    </div>
    <div class="level-grid" id="level-grid"></div>
</div>

<div id="game-view" class="hidden">
    <header class="game-header">
        <button class="back-btn btn-3d" onclick="goHome()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg> è¿”å›
        </button>
        <div class="current-level-title" id="level-title-display">åœºæ™¯åç§°</div>
        <button class="hint-btn btn-3d" onclick="useHint()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.072 0l-.548 5.474a3 3 0 0 1-2.988 2.986h0a3 3 0 0 1-2.988-2.986l-.548-5.474z"/></svg> æç¤º
        </button>
    </header>

    <main class="game-board">
        <div class="scene-wrapper">
            <img src="" id="game-image" class="scene-image" alt="Scene">
            <div id="drop-layer"></div>
        </div>
        <div class="word-bank" id="word-bank"></div>
    </main>
</div>

<div class="modal-overlay" id="win-modal">
    <div class="modal-card">
        <div class="star-container">
            <div class="star-box" id="star-1"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
            <div class="star-box" id="star-2"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
            <div class="star-box" id="star-3"><svg class="star-svg" viewBox="-2 -2 28 28"><path d="M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z"/><circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/></svg></div>
        </div>
        
        <h2 style="font-size: 2.2rem; color: var(--primary-color); margin: 0 0 10px 0; font-weight:900;" id="modal-heading">é—¯å…³æˆåŠŸ!</h2>
        <p style="color:#90A4AE; font: weight 500px; margin: 0 0 15px 0; font-size: 1.1rem;" id="modal-msg">ä½ çœŸæ˜¯ä¸ªå°å¤©æ‰ï¼</p>
        <div id="level-word-list" class="level-word-list"></div>
        <div class="modal-buttons">
            <button class="btn-3d btn-secondary" onclick="goHome()">é€‰å…³</button>
            <button class="btn-3d btn-primary" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
        </div>
    </div>
</div>

<script>
const IMG_EXT = '.png';
const ROUNDED_STAR_PATH = "M12,2.5c1.1,0,2.1,0.6,2.5,1.6l2.6,5.9l6.4,0.6c1.1,0.1,1.9,1.1,1.9,2.2c0,0.5-0.2,1-0.6,1.4l-4.8,4.4l1.4,6.3 c0.3,1.1-0.5,2.1-1.6,2.1c-0.4,0-0.8-0.1-1.2-0.3L12,23.5l-5.6,3.2c-1,0.6-2.2,0.2-2.8-0.8c-0.2-0.4-0.3-0.8-0.3-1.2l1.4-6.3 L0.3,14.1c-0.8-0.8-0.8-2,0-2.8c0.4-0.4,0.8-0.6,1.3-0.6l6.4-0.6l2.6-5.9C10.9,3.1,11.4,2.5,12,2.5z";
const HIGHLIGHT_CIRCLE = '<circle cx="16" cy="9" r="2" fill="white" opacity="0.6"/>';

// å…¨å±€å˜é‡é˜²æ­¢ iOS è¯­éŸ³å¯¹è±¡è¢«å›æ”¶
let currentUtterance = null; 

const levels = {
    insects: { name: 'å¾®è§‚ä¸–ç•Œ', theme: 'å¥‡å¦™æ˜†è™«', img: `insects${IMG_EXT}`, color: '#AED581', items: [
       { id: 'lad', word: 'Ladybug', cn: 'ç“¢è™«', top: '40%', left: '15%' },
        { id: 'but', word: 'Butterfly', cn: 'è´è¶', top: '30%', left: '50%' },
        { id: 'bee', word: 'Bee', cn: 'èœœèœ‚', top: '35%', left: '75%' },
        { id: 'ant', word: 'Ant', cn: 'èš‚èš', top: '50%', left: '35%' },
         { id: 'dra', word: 'Dragonfly', cn: 'èœ»èœ“', top: '50%', left: '65%' },
        { id: 'man', word: 'Mantis', cn: 'è³è‚', top: '65%', left: '85%' },
        { id: 'spi', word: 'Spider', cn: 'èœ˜è››', top: '85%', left: '20%' },
        { id: 'sna', word: 'Snail', cn: 'èœ—ç‰›', top: '90%', left: '50%' }
    ]},
    colors: { name: 'è‰²å½©å¯è’™', theme: 'å¤šå½©é¢œæ–™', img: `colors${IMG_EXT}`, color: '#7986CB', items: [
        { id: 'blu', word: 'Blue', cn: 'è“è‰²', top: '20%', left: '25%' },
        { id: 'yel', word: 'Yellow', cn: 'é»„è‰²', top: '20%', left: '50%' },
        { id: 'pur', word: 'Purple', cn: 'ç´«è‰²', top: '20%', left: '75%' },
        { id: 'red', word: 'Red', cn: 'çº¢è‰²', top: '45%', left: '15%' },
        { id: 'gre', word: 'Green', cn: 'ç»¿è‰²', top: '45%', left: '42%' },
        { id: 'bro', word: 'Brown', cn: 'æ£•è‰²', top: '40%', left: '90%' },
        { id: 'bla', word: 'Black', cn: 'é»‘è‰²', top: '75%', left: '30%' },
        { id: 'ora', word: 'Orange', cn: 'æ©™è‰²', top: '70%', left: '65%' },
        { id: 'whi', word: 'White', cn: 'ç™½è‰²', top: '65%', left: '88%' }
    ]},
    birds: { name: 'å¤©ç©ºç²¾çµ', theme: 'è®¤è¯†é¸Ÿç±»', img: `birds${IMG_EXT}`, color: '#4DD0E1', items: [
        { id: 'spa', word: 'Sparrow', cn: 'éº»é›€', top: '20%', left: '15%' },
        { id: 'pig', word: 'Pigeon', cn: 'é¸½å­', top: '20%', left: '40%' },
        { id: 'par', word: 'Parrot', cn: 'é¹¦é¹‰', top: '25%', left: '60%' },
        { id: 'hum', word: 'Hummingbird', cn: 'èœ‚é¸Ÿ', top: '15%', left: '85%' },
        { id: 'owl', word: 'Owl', cn: 'çŒ«å¤´é¹°', top: '65%', left: '32%' },
        { id: 'mag', word: 'Magpie', cn: 'å–œé¹Š', top: '65%', left: '50%' },
        { id: 'woo', word: 'Woodpecker', cn: 'å•„æœ¨é¸Ÿ', top: '60%', left: '85%' },
        { id: 'nes', word: 'Nest', cn: 'é¸Ÿå·¢', top: '75%', left: '15%' }
    ]},
    animals: { name: 'çƒ­é—¹åŠ¨ç‰©å›­', theme: 'è‡ªç„¶ç”Ÿç‰©', img: `animals${IMG_EXT}`, color: '#FF8A80', items: [
        { id: 'gir', word: 'Giraffe', cn: 'é•¿é¢ˆé¹¿', top: '30%', left: '15%' },
        { id: 'ele', word: 'Elephant', cn: 'å¤§è±¡', top: '35%', left: '45%' },
        { id: 'lio', word: 'Lion', cn: 'ç‹®å­', top: '75%', left: '80%' },
        { id: 'zeb', word: 'Zebra', cn: 'æ–‘é©¬', top: '70%', left: '25%' },
        { id: 'pan', word: 'Panda', cn: 'ç†ŠçŒ«', top: '85%', left: '50%' },
        { id: 'mon', word: 'Monkey', cn: 'çŒ´å­', top: '20%', left: '80%' },
        { id: 'tre', word: 'Tree', cn: 'æ ‘', top: '60%', left: '60%' }
    ]},
    marine: { name: 'å¥‡å¹»æµ·æ´‹é¦†', theme: 'æ·±æµ·æ¢ç§˜', img: `marine${IMG_EXT}`, color: '#4FC3F7', items: [
        { id: 'jel', word: 'Jellyfish', cn: 'æ°´æ¯', top: '20%', left: '60%' },
        { id: 'sta', word: 'Starfish', cn: 'æµ·æ˜Ÿ', top: '25%', left: '35%' },
        { id: 'tur', word: 'Sea Turtle', cn: 'æµ·é¾Ÿ', top: '70%', left: '80%' },
        { id: 'cra', word: 'Crab', cn: 'èƒèŸ¹', top: '75%', left: '45%' },
        { id: 'fis', word: 'Fish', cn: 'é±¼', top: '25%', left: '85%' },
        { id: 'she', word: 'Shell', cn: 'è´å£³', top: '25%', left: '15%' },
        { id: 'cor', word: 'Coral', cn: 'çŠç‘š', top: '75%', left: '15%' }
    ]},
    fruit: { name: 'é²œç¾æ°´æœæ‘Š', theme: 'å¥åº·é¥®é£Ÿ', img: `fruit${IMG_EXT}`, color: '#FFD54F', items: [
        { id: 'wat', word: 'Watermelon', cn: 'è¥¿ç“œ', top: '50%', left: '50%' },
        { id: 'ban', word: 'Banana', cn: 'é¦™è•‰', top: '85%', left: '14%' },
        { id: 'ora', word: 'Orange', cn: 'æ©™å­', top: '75%', left: '30%' },
        { id: 'gra', word: 'Grape', cn: 'è‘¡è„', top: '65%', left: '70%' },
        { id: 'app', word: 'Apple', cn: 'è‹¹æœ', top: '50%', left: '15%' },
        { id: 'pin', word: 'Pineapple', cn: 'è è', top: '35%', left: '85%' },
        { id: 'lem', word: 'Lemon', cn: 'æŸ æª¬', top: '80%', left: '85%' },
        { id: 'str', word: 'Strawberry', cn: 'è‰è“', top: '80%', left: '50%' }
    ]},
    clothes: { name: 'æ—¶å°šç©¿æ­', theme: 'æ—¥å¸¸ç”Ÿæ´»', img: `clothes${IMG_EXT}`, color: '#81C784', items: [
        { id: 'coa', word: 'Coat', cn: 'å¤–å¥—', top: '35%', left: '22%' },
        { id: 'hat', word: 'Hat', cn: 'å¸½å­', top: '25%', left: '48%' },
        { id: 'sca', word: 'Scarf', cn: 'å›´å·¾', top: '35%', left: '82%' },
        { id: 'bag', word: 'Backpack', cn: 'èƒŒåŒ…', top: '70%', left: '60%' },
        { id: 'mit', word: 'Mittens', cn: 'æ‰‹å¥—', top: '60%', left: '40%' },
        { id: 'soc', word: 'Socks', cn: 'è¢œå­', top: '80%', left: '82%' },
        { id: 'boo', word: 'Boots', cn: 'é´å­', top: '85%', left: '30%' }
    ]},
    stationery: { name: 'å°å°æ–‡å…·åº—', theme: 'å­¦ä¹ ç”¨å“', img: `stationery${IMG_EXT}`, color: '#AB47BC', items: [
        { id: 'rul', word: 'Ruler', cn: 'ç›´å°º', top: '85%', left: '25%' },
        { id: 'pen', word: 'Pencil', cn: 'é“…ç¬”', top: '50%', left: '18%' },
        { id: 'era', word: 'Eraser', cn: 'æ©¡çš®', top: '70%', left: '8%' },
        { id: 'not', word: 'Notebook', cn: 'ç¬”è®°æœ¬', top: '30%', left: '35%' },
        { id: 'sci', word: 'Scissors', cn: 'å‰ªåˆ€', top: '60%', left: '85%' },
        { id: 'tap', word: 'Tape', cn: 'èƒ¶å¸¦', top: '87%', left: '82%' },
        { id: 'hol', word: 'Pen Holder', cn: 'ç¬”ç­’', top: '25%', left: '65%' },
        { id: 'ope', word: 'Notepad', cn: 'è®°äº‹æœ¬', top: '65%', left: '53%' }
    ]},
    art: { name: 'ç¼¤çº·ç”»å®¤', theme: 'è‰ºæœ¯åˆ›ä½œ', img: `art${IMG_EXT}`, color: '#26C6DA', items: [
        { id: 'buc', word: 'Bucket', cn: 'æ°´æ¡¶', top: '30%', left: '22%' },
        { id: 'pal', word: 'Palette', cn: 'è°ƒè‰²ç›˜', top: '70%', left: '20%' },
        { id: 'bru', word: 'Paintbrush', cn: 'ç”»ç¬”', top: '65%', left: '40%' },
        { id: 'apr', word: 'Apron', cn: 'å›´è£™', top: '70%', left: '55%' },
        { id: 'pai', word: 'Paints', cn: 'é¢œæ–™', top: '28%', left: '53%' },
        { id: 'eas', word: 'Easel', cn: 'ç”»æ¶', top: '45%', left: '78%' }
    ]},
    vegetables: { name: 'å¥åº·èœç¯®å­', theme: 'ç”°å›­æ—¶å…‰', img: `vegetables${IMG_EXT}`, color: '#FF7043', items: [
        { id: 'car', word: 'Carrot', cn: 'èƒ¡èåœ', top: '45%', left: '15%' },
        { id: 'tom', word: 'Tomato', cn: 'è¥¿çº¢æŸ¿', top: '30%', left: '35%' },
        { id: 'cuc', word: 'Cucumber', cn: 'é»„ç“œ', top: '45%', left: '45%' },
        { id: 'pot', word: 'Potato', cn: 'åœŸè±†', top: '82%', left: '38%' },
        { id: 'pep', word: 'Green Pepper', cn: 'é’æ¤’', top: '75%', left: '62%' },
        { id: 'pum', word: 'Pumpkin', cn: 'å—ç“œ', top: '60%', left: '85%' },
        { id: 'gre', word: 'Vegetable', cn: 'é’èœ', top: '20%', left: '75%' }
    ]},
    occupations: { name: 'èŒä¸šå¤§ç™¾ç§‘', theme: 'ç¤¾ä¼šåˆ†å·¥', img: `occupations${IMG_EXT}`, color: '#5C6BC0', items: [
        { id: 'doc', word: 'Doctor', cn: 'åŒ»ç”Ÿ', top: '45%', left: '15%' },
         { id: 'nur', word: 'Nurse', cn: 'æŠ¤å£«', top: '10%', left: '75%' },
        { id: 'pol', word: 'Police', cn: 'è­¦å¯Ÿ', top: '45%', left: '82%' },
         { id: 'fir', word: 'Firefighter', cn: 'æ¶ˆé˜²å‘˜', top: '35%', left: '55%' },
        { id: 'che', word: 'Chef', cn: 'å¨å¸ˆ', top: '55%', left: '42%' },
         { id: 'tea', word: 'Teacher', cn: 'è€å¸ˆ', top: '35%', left: '32%' },
        { id: 'wor', word: 'Worker', cn: 'å·¥äºº', top: '60%', left: '65%' },
         { id: 'stu', word: 'Student', cn: 'å­¦ç”Ÿ', top: '70%', left: '25%' }
    ]},
    vehicles: { name: 'è½¦æ°´é©¬é¾™', theme: 'äº¤é€šå·¥å…·', img: `vehicles${IMG_EXT}`, color: '#EF5350', items: [
        { id: 'bic', word: 'Bicycle', cn: 'è‡ªè¡Œè½¦', top: '25%', left: '18%' },
         { id: 'bus', word: 'Bus', cn: 'å…¬äº¤è½¦', top: '35%', left: '50%' },
        { id: 'amb', word: 'Ambulance', cn: 'æ•‘æŠ¤è½¦', top: '38%', left: '82%' }, 
        { id: 'car', word: 'Car', cn: 'æ±½è½¦', top: '60%', left: '20%' },
        { id: 'mot', word: 'Motorcycle', cn: 'æ‘©æ‰˜è½¦', top: '85%', left: '18%' }, 
        { id: 'sco', word: 'Scooter', cn: 'æ»‘æ¿è½¦', top: '85%', left: '45%' },
        { id: 'fit', word: 'Fire Truck', cn: 'æ¶ˆé˜²è½¦', top: '80%', left: '78%' }
    ]},
    trees: { name: 'æ£®æ—æ¤ç‰©', theme: 'è‡ªç„¶æ¢ç´¢', img: `trees${IMG_EXT}`, color: '#66BB6A', items: [
        { id: 'pin', word: 'Pine Tree', cn: 'æ¾æ ‘', top: '42%', left: '15%' }, 
        { id: 'map', word: 'Maple Leaf', cn: 'æ«å¶', top: '42%', left: '38%' },
        { id: 'oak', word: 'Oak Tree', cn: 'æ©¡æ ‘', top: '42%', left: '62%' }, 
        { id: 'bir', word: 'Birch', cn: 'æ¡¦æ ‘', top: '40%', left: '85%' },
        { id: 'sma', word: 'Sapling', cn: 'æ ‘è‹—', top: '75%', left: '25%' },
         { id: 'big', word: 'Big Tree', cn: 'å¤§æ ‘', top: '75%', left: '50%' },
        { id: 'gin', word: 'Ginkgo', cn: 'é“¶æ', top: '78%', left: '75%' }
    ]},
    balls: { name: 'çƒç±»è¿åŠ¨', theme: 'å¥åº·ç”Ÿæ´»', img: `balls${IMG_EXT}`, color: '#FFA726', items: [
        { id: 'bas', word: 'Basketball', cn: 'ç¯®çƒ', top: '30%', left: '70%' },
         { id: 'soc', word: 'Soccer', cn: 'è¶³çƒ', top: '25%', left: '30%' },
        { id: 'vol', word: 'Volleyball', cn: 'æ’çƒ', top: '33%', left: '50%' }, 
        { id: 'ten', word: 'Tennis', cn: 'ç½‘çƒ', top: '68%', left: '8%' },
        { id: 'rug', word: 'Rugby', cn: 'æ©„æ¦„çƒ', top: '78%', left: '35%' },
         { id: 'han', word: 'Handball', cn: 'æ‰‹çƒ', top: '72%', left: '65%' },
        { id: 'bsb', word: 'Baseball', cn: 'æ£’çƒ', top: '70%', left: '85%' }, 
        { id: 'bad', word: 'Badminton', cn: 'ç¾½æ¯›çƒ', top: '88%', left: '55%' },
        { id: 'pin', word: 'Ping Pong', cn: 'ä¹’ä¹“çƒ', top: '82%', left: '22%' }
    ]},
    drinks: { name: 'ç¾å‘³é¥®å“', theme: 'æ¸…å‡‰è§£æ¸´', img: `drinks${IMG_EXT}`, color: '#FFB74D', items: [
        { id: 'mil', word: 'Milk', cn: 'ç‰›å¥¶', top: '45%', left: '10%' },
        { id: 'jui', word: 'Juice', cn: 'æœæ±', top: '25%', left: '26%' },
        { id: 'tea', word: 'Iced Tea', cn: 'å†°èŒ¶', top: '65%', left: '38%' },
        { id: 'sod', word: 'Soda', cn: 'æ±½æ°´', top: '30%', left: '50%' },
        { id: 'cof', word: 'Coffee', cn: 'å’–å•¡', top: '65%', left: '60%' },
        { id: 'wat', word: 'Water', cn: 'çŸ¿æ³‰æ°´', top: '20%', left: '72%' },
        { id: 'lem', word: 'Lemonade', cn: 'æŸ æª¬æ°´', top: '45%', left: '88%' }
    ]},
    tools: { name: 'ç”Ÿæ´»å·¥å…·', theme: 'å°å°å·¥åŒ ', img: `tools${IMG_EXT}`, color: '#90A4AE', items: [
        { id: 'ham', word: 'Hammer', cn: 'é”¤å­', top: '30%', left: '10%' },
        { id: 'scr', word: 'Screwdriver', cn: 'èºä¸åˆ€', top: '55%', left: '23%' },
        { id: 'saw', word: 'Saw', cn: 'é”¯å­', top: '40%', left: '35%' },
        { id: 'pli', word: 'Pliers', cn: 'é’³å­', top: '35%', left: '48%' },
        { id: 'rul', word: 'Ruler', cn: 'å°ºå­', top: '55%', left: '62%' },
        { id: 'nai', word: 'Screw', cn: 'èºä¸', top: '70%', left: '73%' },
        { id: 'dri', word: 'Drill', cn: 'ç”µé’»', top: '25%', left: '86%' }
    ]},
    furniture: { name: 'æ¸©é¦¨å®¶å›­', theme: 'æ—¥å¸¸å®¶å…·', img: `furniture${IMG_EXT}`, color: '#8D6E63', items: [
        { id: 'sof', word: 'Sofa', cn: 'æ²™å‘', top: '45%', left: '20%' },
        { id: 'lam', word: 'Lamp', cn: 'è½åœ°ç¯', top: '25%', left: '46%' },
        { id: 'tv', word: 'TV', cn: 'ç”µè§†', top: '30%', left: '65%' },
        { id: 'cab', word: 'Cabinet', cn: 'ç”µè§†æŸœ', top: '55%', left: '65%' },
        { id: 'boo', word: 'Bookshelf', cn: 'ä¹¦æ¶', top: '20%', left: '88%' },
        { id: 'tab', word: 'Table', cn: 'æ¡Œå­', top: '70%', left: '45%' },
        { id: 'rug', word: 'Rug', cn: 'åœ°æ¯¯', top: '85%', left: '45%' },
        { id: 'cha', word: 'Chair', cn: 'æ¤…å­', top: '75%', left: '90%' }
    ]},
    flags: { name: 'ä¸–ç•Œå›½æ——', theme: 'è®¤è¯†å›½å®¶', img: `flags${IMG_EXT}`, color: '#EF5350', items: [
        { id: 'ger', word: 'Germany', cn: 'å¾·å›½', top: '28%', left: '20%' },
        { id: 'uk', word: 'UK', cn: 'è‹±å›½', top: '28%', left: '50%' },
        { id: 'usa', word: 'USA', cn: 'ç¾å›½', top: '28%', left: '80%' },
        { id: 'ind', word: 'India', cn: 'å°åº¦', top: '58%', left: '20%' },
        { id: 'chn', word: 'China', cn: 'ä¸­å›½', top: '58%', left: '50%' },
        { id: 'bra', word: 'Brazil', cn: 'å·´è¥¿', top: '58%', left: '80%' },
        { id: 'can', word: 'Canada', cn: 'åŠ æ‹¿å¤§', top: '88%', left: '20%' },
        { id: 'fra', word: 'France', cn: 'æ³•å›½', top: '88%', left: '50%' },
        { id: 'chi', word: 'Chile', cn: 'æ™ºåˆ©', top: '88%', left: '80%' }
    ]}
};

const levelOrder = Object.keys(levels);
let currentLevelKey = '';
let mistakeCount = 0;
let hintUsed = false;
let audioUnlocked = false; 
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();

function hexToRgba(hex, alpha) {
    let r = 0, g = 0, b = 0;
    if (hex.length === 4) {
        r = parseInt(hex[1] + hex[1], 16);
        g = parseInt(hex[2] + hex[2], 16);
        b = parseInt(hex[3] + hex[3], 16);
    } else if (hex.length === 7) {
        r = parseInt(hex.substring(1, 3), 16);
        g = parseInt(hex.substring(3, 5), 16);
        b = parseInt(hex.substring(5, 7), 16);
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// iOS éŸ³é¢‘è§£é”ï¼šåœ¨ç¬¬ä¸€æ¬¡è§¦æ‘¸å±å¹•æ—¶æ¢å¤ AudioContext
function unlockAudio() {
    if (!audioUnlocked && audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
            audioUnlocked = true;
        });
    }
}
document.addEventListener('touchstart', unlockAudio, { once: true });
document.addEventListener('click', unlockAudio, { once: true });

function speakWord(text) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel(); 
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; // å»ºè®®æ”¹ä¸º en-US å…¼å®¹æ€§æ›´å¥½
    utterance.rate = 0.75; 
    utterance.volume = 1;

    // å°è¯•è·å–æ›´è‡ªç„¶çš„è¯­éŸ³
    const voices = window.speechSynthesis.getVoices();
    const voice = voices.find(v => v.lang.includes('US') || v.lang.includes('UK'));
    if (voice) utterance.voice = voice;
    
    // ğŸ”´ å…³é”®ä¿®å¤ï¼šé˜²æ­¢iOSåƒåœ¾å›æ”¶å¯¼è‡´å£°éŸ³ä¸­æ–­
    currentUtterance = utterance;
    utterance.onend = () => { currentUtterance = null; };
    
    window.speechSynthesis.speak(utterance);
}
if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); };
}

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    
    if (type === 'success') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(500, now);
        osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'error') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(150, now);
        osc.frequency.linearRampToValueAtTime(80, now + 0.2);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'win') {
        const notes = [400, 500, 600, 800, 1000];
        notes.forEach((freq, i) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g);
            g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.value = freq;
            g.gain.setValueAtTime(0.1, now + i*0.1);
            g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.5);
            o.start(now + i*0.1); o.stop(now + i*0.1 + 0.5);
        });
    }
}

function getStars(level) {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    return data[level] || 0;
}
function getAllStarsCount() {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    return Object.values(data).reduce((acc, curr) => acc + curr, 0);
}
function saveStars(level, count) {
    const data = JSON.parse(localStorage.getItem('wordGameProgress') || '{}');
    if (!data[level] || count > data[level]) {
        data[level] = count;
        localStorage.setItem('wordGameProgress', JSON.stringify(data));
    }
}

window.onload = () => { renderHome(); };

function renderHome() {
    const grid = document.getElementById('level-grid');
    grid.innerHTML = ''; 
    document.getElementById('total-stars-count').innerText = getAllStarsCount();

    levelOrder.forEach(key => {
        const level = levels[key];
        const stars = getStars(key);
        const wordPreview = level.items.slice(0, 4).map(item => item.word).join(' Â· ');

        const card = document.createElement('div');
        card.className = 'level-card';
        card.style.setProperty('--level-color', level.color);
        card.style.setProperty('--level-bg-alpha', hexToRgba(level.color, 0.1));
        card.onclick = () => enterGame(key);

        let starsHtml = '';
        for(let i=1; i<=3; i++) {
            starsHtml += `<svg class="rounded-star ${i <= stars ? 'earned' : ''}" viewBox="-2 -2 28 28"><path d="${ROUNDED_STAR_PATH}" />${HIGHLIGHT_CIRCLE}</svg>`;
        }

        card.innerHTML = `
            <div class="card-header-bg"><div class="card-header-row"><h3 class="card-title">${level.name}</h3><span class="card-tag">${level.theme}</span></div></div>
            <div class="card-body"><div class="preview-words">${wordPreview}</div><div class="card-footer"><div class="card-stars">${starsHtml}</div><div class="play-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></div></div></div>
        `;
        grid.appendChild(card);
    });

    document.getElementById('home-view').classList.remove('hidden');
    document.getElementById('game-view').classList.add('hidden');
    document.getElementById('home-view').classList.add('fade-in');
    window.scrollTo(0, 0);
}

function goHome() {
    document.getElementById('win-modal').style.display = 'none';
    renderHome();
}

function enterGame(key) {
    document.getElementById('home-view').classList.add('hidden');
    const gameView = document.getElementById('game-view');
    gameView.classList.remove('hidden');
    gameView.classList.add('fade-in');
    loadLevel(key);
}

function loadLevel(levelKey) {
    currentLevelKey = levelKey;
    const data = levels[levelKey];
    
    document.documentElement.style.setProperty('--current-theme', data.color);
    document.documentElement.style.setProperty('--current-theme-alpha', hexToRgba(data.color, 0.4));
    document.getElementById('level-title-display').textContent = data.name;

    mistakeCount = 0;
    hintUsed = false;
    
    const dropLayer = document.getElementById('drop-layer');
    const wordBank = document.getElementById('word-bank');
    const imgEl = document.getElementById('game-image');
    
    imgEl.style.opacity = 0;
    imgEl.src = data.img;
    imgEl.onload = () => imgEl.style.opacity = 1;
    imgEl.onerror = () => { imgEl.alt = "å›¾ç‰‡åŠ è½½å¤±è´¥: " + data.img; imgEl.style.opacity = 1; };

    dropLayer.innerHTML = '';
    data.items.forEach(item => {
        const target = document.createElement('div');
        target.className = 'drop-target';
        target.style.top = item.top;
        target.style.left = item.left;
        target.dataset.match = item.id;
        
        target.addEventListener('dragover', e => { e.preventDefault(); if(!target.classList.contains('filled')) target.classList.add('hovered'); });
        target.addEventListener('dragleave', () => target.classList.remove('hovered'));
        target.addEventListener('drop', handleDrop);
        
        dropLayer.appendChild(target);
    });

    wordBank.innerHTML = '';
    const shuffled = [...data.items].sort(() => Math.random() - 0.5);
    shuffled.forEach(item => {
        const card = document.createElement('div');
        card.className = 'word-card';
        card.draggable = true;
        card.textContent = item.word;
        card.id = `word-${item.id}`;
        card.dataset.id = item.id;
        card.dataset.themeColor = data.color;
        
        if (item.customSpeak) {
            card.dataset.customSpeak = item.customSpeak;
        }
        
        card.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text', item.id);
            e.dataTransfer.setData('elId', card.id);
            if (audioCtx.state === 'suspended') audioCtx.resume();
        });
        
        // iPad/Touch è§¦æ‘¸æ”¯æŒ
        addTouchLogic(card, item.id);
        
        wordBank.appendChild(card);
    });
}

// --- iPad è§¦æ‘¸é€»è¾‘ ---
function addTouchLogic(card, itemId) {
    let startX, startY;
    let initialLeft, initialTop;
    
    card.addEventListener('touchstart', function(e) {
        if(e.touches.length > 1) return; 
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        
        const rect = card.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        
        card.style.position = 'fixed';
        card.style.left = initialLeft + 'px';
        card.style.top = initialTop + 'px';
        card.style.width = rect.width + 'px'; 
        card.classList.add('dragging');
        
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }, { passive: false });

    card.addEventListener('touchmove', function(e) {
        e.preventDefault(); 
        const touch = e.touches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;
        
        card.style.left = (initialLeft + deltaX) + 'px';
        card.style.top = (initialTop + deltaY) + 'px';
        
        checkTouchHover(touch.clientX, touch.clientY);
    }, { passive: false });

    card.addEventListener('touchend', function(e) {
        const touch = e.changedTouches[0];
        card.classList.remove('dragging');
        
        card.style.display = 'none';
        let elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        card.style.display = 'flex';
        
        const dropTarget = elemBelow ? elemBelow.closest('.drop-target') : null;
        
        card.style.position = '';
        card.style.left = '';
        card.style.top = '';
        card.style.width = '';
        
        document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('hovered'));

        if (dropTarget && !dropTarget.classList.contains('filled')) {
            if (dropTarget.dataset.match === itemId) {
                playSound('success');
                finishDrop(dropTarget, card);
            } else {
                playSound('error');
                mistakeCount++;
                dropTarget.classList.add('wrong-shake');
                setTimeout(() => dropTarget.classList.remove('wrong-shake'), 400);
            }
        }
    });
}

function checkTouchHover(x, y) {
    const dragged = document.querySelector('.word-card.dragging');
    if(dragged) dragged.style.visibility = 'hidden';
    
    let elem = document.elementFromPoint(x, y);
    
    if(dragged) dragged.style.visibility = 'visible';
    
    document.querySelectorAll('.drop-target.hovered').forEach(el => el.classList.remove('hovered'));
    
    if(elem) {
        const target = elem.closest('.drop-target');
        if(target && !target.classList.contains('filled')) {
            target.classList.add('hovered');
        }
    }
}

function finishDrop(target, originalCard) {
    target.classList.add('filled');
    target.classList.remove('hint-target');
    
    const activeCard = document.querySelector('.word-card.hint-target');
    if(activeCard) activeCard.classList.remove('hint-target');
    
    const placedCard = document.createElement('div');
    placedCard.className = 'word-card placed';
    
    const wordText = originalCard.textContent;
    const customSpeak = originalCard.dataset.customSpeak;

    placedCard.textContent = wordText;
    const themeColor = originalCard.dataset.themeColor;
    placedCard.style.backgroundColor = themeColor;
    placedCard.style.color = (themeColor === '#FFD54F') ? '#333333' : '#FFFFFF';
    
    target.innerHTML = '';
    target.appendChild(placedCard);
    originalCard.remove();
    
    const textToRead = customSpeak || wordText;
    // ğŸ”´ å…³é”®ä¿®å¤ï¼šç§»é™¤ setTimeout å»¶æ—¶ï¼Œåœ¨ç”¨æˆ·äº¤äº’é“¾æ¡ä¸­ç«‹å³æ’­æ”¾
    speakWord(textToRead); 

    checkWin();
}

function handleDrop(e) {
    e.preventDefault();
    const target = e.currentTarget;
    target.classList.remove('hovered');
    if(target.classList.contains('filled')) return;

    const droppedId = e.dataTransfer.getData('text');
    const elId = e.dataTransfer.getData('elId');
    const originalCard = document.getElementById(elId);

    if (droppedId === target.dataset.match) {
        playSound('success');
        finishDrop(target, originalCard);
    } else {
        playSound('error');
        mistakeCount++;
        target.classList.add('wrong-shake');
        setTimeout(() => target.classList.remove('wrong-shake'), 400);
    }
}

function useHint() {
    const emptyTargets = Array.from(document.querySelectorAll('.drop-target:not(.filled)'));
    if (emptyTargets.length === 0) return;
    
    document.querySelectorAll('.hint-target').forEach(el => el.classList.remove('hint-target'));

    const target = emptyTargets[Math.floor(Math.random() * emptyTargets.length)];
    const matchId = target.dataset.match;
    const card = document.querySelector(`.word-bank .word-card[data-id="${matchId}"]`);
    
    if (target && card) {
        hintUsed = true;
        target.classList.add('hint-target');
        card.classList.add('hint-target');
        
        setTimeout(() => {
            target.classList.remove('hint-target');
            card.classList.remove('hint-target');
        }, 2000);
    }
}

function checkWin() {
    const data = levels[currentLevelKey];
    const totalItems = data.items.length;
    const filledItems = document.querySelectorAll('.drop-target.filled').length;

    if (filledItems === totalItems) {
        setTimeout(() => {
            playSound('win');
            showWinModal();
        }, 2500); 
    }
}

function showWinModal() {
    const modal = document.getElementById('win-modal');
    const stars = [
        document.getElementById('star-1'),
        document.getElementById('star-2'),
        document.getElementById('star-3')
    ];
    const heading = document.getElementById('modal-heading');
    const msg = document.getElementById('modal-msg');
    
    stars.forEach(s => s.classList.remove('active'));
    
    let starCount = 0;
    if (hintUsed) {
        starCount = 1; heading.innerText = "å®ŒæˆæŒ‘æˆ˜!"; msg.innerText = "ä½¿ç”¨äº†æç¤ºï¼Œä¸‹æ¬¡è¯•è¯•é è‡ªå·±ï¼";
    } else if (mistakeCount === 0) {
        starCount = 3; heading.innerText = "å®Œç¾é€šå…³!"; msg.innerText = "å¤ªæ£’äº†ï¼ç™¾å‘ç™¾ä¸­ï¼";
    } else if (mistakeCount <= 2) {
        starCount = 2; heading.innerText = "åšå¾—ä¸é”™!"; msg.innerText = "å·®ç‚¹å°±æ»¡åˆ†äº†ï¼ŒåŠ æ²¹ï¼";
    } else {
        starCount = 1; heading.innerText = "é—¯å…³æˆåŠŸ!"; msg.innerText = "ç»§ç»­åŠ æ²¹ï¼Œä½ ä¼šæ›´æ£’çš„ï¼";
    }

    saveStars(currentLevelKey, starCount);

    const listContainer = document.getElementById('level-word-list');
    listContainer.innerHTML = ''; 
    
    const currentData = levels[currentLevelKey];
    if (currentData && currentData.items) {
        currentData.items.forEach(item => {
            const row = document.createElement('div');
            row.className = 'word-list-item';
            const cnText = item.cn || ''; 
            row.innerHTML = `<span class="word-en">${item.word}</span><span class="word-cn">${cnText}</span>`;
            listContainer.appendChild(row);
        });
    }

    modal.style.display = 'flex';
    for(let i=0; i<starCount; i++) {
        setTimeout(() => {
            stars[i].classList.add('active');
        }, i * 200 + 300);
    }
}

function nextLevel() {
    document.getElementById('win-modal').style.display = 'none';
    let currentIndex = levelOrder.indexOf(currentLevelKey);
    let nextIndex = currentIndex + 1;
    
    if (nextIndex >= levelOrder.length) {
        alert("æ­å–œä½ ï¼Œé€šå…³äº†æ‰€æœ‰åœºæ™¯ï¼");
        goHome();
    } else {
        loadLevel(levelOrder[nextIndex]);
    }
}
</script>
</body>
</html>
